# stateAutomation
Node JS program to automate state education forms

# Setup
Create .env file or setup env variables on deployment ui to include the following:
USER = <username>
PASSWORD=<password+4>

## Overview
This project contains two main functions:

1. `GenerateToken`: A function that uses Puppeteer to perform automated browser actions to log in to a specified website, retrieve cookies, and return a formatted token for authentication in other applications.
2. `RunCollection`: A function that utilizes Newman (Postman CLI) to execute a Postman collection using the token generated by `GenerateToken`.

## Prerequisites
- **Node.js** installed on your machine
- **Puppeteer** for browser automation
- **Newman** (Postman CLI) for running Postman collections
- **Environment Variables**:
  - `USER`: Username for login.
  - `PASSWORD`: Password for login.
  - `PUPPETEER_EXECUTABLE_PATH`: Path for the Puppeteer executable in a production environment (optional).

## Functions

### 1. `GenerateToken`

This function initiates a Puppeteer instance to:
- Open a login page, fill in credentials, and retrieve cookies.
- Format cookies as a token string for use in other applications.
- Implement retry logic for failed attempts, with a maximum of 3 retry attempts.

#### Parameters:
- `retryCount`: (Optional) Tracks retry attempts if an error occurs (default is `0`).

#### Returns:
- A `Three60ReviewCookies` token if login is successful.
- Otherwise, logs an error and exits after reaching the maximum retry attempts.

#### Key Steps:
1. Launches a Puppeteer browser instance with specific options for optimal performance.
2. Navigates to the login page and logs in using credentials.
3. Collects cookies from the authenticated session.
4. Formats and returns the cookies in a format compatible with Postman requests.

#### Example Usage:
```javascript
const token = await GenerateToken();
console.log("Generated Token:", token);

### 2. `RunCollection`

The `RunCollection` function allows you to execute a specified Postman collection using the token generated by `GenerateToken`.

#### Parameters:
- **`req`**: The request object containing the `body` payload, used to set the environment variable in Postman.
- **`token`**: The session token from `GenerateToken`, used for authenticating requests within the collection.
- **`collection`**: The name of the Postman collection file (without `.json` extension) to be run.

#### Returns:
- **`Promise`**: Resolves to `responseDataList`, which holds responses for each request in the collection, or rejects with an error if the collection run fails.

#### Key Steps:
1. **Configures Collection**:
    - Sets up `collectionToRun` object with Postman environment variables, including `payload` from `req.body` and `session_cookie` with the `token`.
2. **Executes Collection**:
    - Runs the collection using Newman.
    - Logs and collects `responseData` from each run.
3. **Error Handling**:
    - If an error occurs, it logs the error and rejects the promise.




### 3. 'Collections'
- save_incident.postman_collection: "submits incident to 360 using review360 api"
- poll_session.postman_collection: "checks status of token and returns status boolean and remaning time"
- ativate_session.postman_collection:"allows you to renew token as needed"


### Instruction for Deployment
Containerized with Docker and Pushed to run cloud
1) docker build -t gcr.io/krowd-automation-newmen/stateautomation:v1 .
2)  docker push gcr.io/krowd-automation-newmen/stateautomation:v1 
3) gcloud run deploy calendar-service --image gcr.io/krowd-automation-newmen/stateautomation:v1 --platform managed


https://www.psiwaresolution.com/Review360/Incident/New/teacher-managed

https://www.psiwaresolution.com/Review360/Incident/New/teacher-referral-for-office-managed

https://www.psiwaresolution.com/Review360/Incident/New/positive-behavior-achievement

## saveIncident api still works. letws use taht still

sample payload{"Parties":[],"Incident_IncidentTypeId":{"value":40,"text":"Positive Behavior Achievement"},"Incident_IncidentConfigurationGroupId":207,"Incident_VersionDate":{"date":"02/02/2025","time":null},"Incident_IncidentDate":{"date":"02/02/2025","time":"7:00 AM"},"Incident_ReportedById":{"value":2509677,"text":"Iverson, Justin"},"Incident_OccurredAtOrganizationId":{"value":6597,"text":"Simmons Pinckney Middle"},"IncidentParty_IncidentPartyId":-1,"CurrentUser":{"value":2509677,"text":"Iverson, Justin"},"IncidentParty_IncidentPartyTypeId":{"value":1,"text":""},"IncidentParty_StudentId":{"value":4596508,"text":"Amous, Sharon (17443)"},"Incident_LocationId":{"value":48,"text":"Arrival"},"IncidentBehavior_LayoutFieldOptionId":[{"value":322688,"text":" Being Respectful","isPrimary":null,"isRemoved":false}],"IncidentParty_Description":"Great Energy Coming To School, Complimented Others","IncidentStaffResponse_LayoutFieldOptionId":[{"value":322703,"text":" Recognition"}],"IncidentTypeRole_IncidentRoleId":1,"IsReadyToAssignActions":false,"BehaviorRequiredForActions":true,"IncidentParty_StudentNumber":"17443","IncidentParty_StudentGradeId":{"text":"7th Grade","value":7},"IncidentParty_StudentOrganizationId":{"text":"Simmons Pinckney Middle","value":6597},"IncidentParty_StudentIsSpecialEducation":{"text":"Yes","value":true},"IncidentParty_StudentIs504":{"text":"No","value":false},"IncidentParty_StudentHomelessTypeId":{"text":"Not Homeless","value":1},"RuleInstanceToken":null}